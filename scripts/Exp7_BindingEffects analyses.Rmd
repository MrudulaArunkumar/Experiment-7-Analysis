rm(list=ls())

#notwendige Pakete laden####
```{r}
library(plyr)
library(lme4)
library(tidyverse)
library(ez)
library(ggplot2)
library(schoRsch)
library(here)

```
#set working directory
#set_here()
setwd("~/Daten/1 BRAC-FOR/overshadowing/Exp 7/Analysis")


# Exp7data <- read.csv(file="Data/Exp7_fulldataset.csv")
# 
# Exp7data$participant <- as.factor(Exp7data$participant)
# 
# 
# 
# # Data preparation and cleaning
# 
# # -   Removing unnecessary columns generated by psychopy
# # -   Preparing the RT trial, by eliminating the square brackets and splitting it in cases where two keys were registered.
# # -   Creating a column for Accuracy and Error Rate
# # -   adding a Bonus column that computes the points received by each participant
# 
# Exp7data <- Exp7data %>%
#   select(-X,-ConsentKey.keys,-ConsentKey.rt,-Begin.keys,-Begin.rt,-checkresp.corr,-checkresp.keys,-checkresp.rt,-Attention.thisRepN,-Attention.thisTrialN,-Attention.thisN,-Attention.thisIndex,-Attention.ran,-AttnQuestion,-AttnAnswer,-NextStep.keys,-NextStep.rt,-InstRep.ran,-InstRep.thisN,-InstRep.thisTrialN,-InstRep.thisRepN,-InstRep.thisIndex,-PracProceed.keys,-PracProceed.rt,-Prac_loop.thisRepN,-Prac_loop.thisTrialN,-Prac_loop.thisN,-Prac_loop.thisIndex,-Prac_loop.ran,-Exp_proceed.keys,-Exp_proceed.rt,-PracRepeat.ran,-PracRepeat.thisRepN,-PracRepeat.thisN,-PracRepeat.thisIndex,-PracRepeat.thisTrialN,-brkContinue.keys,-PauseResp.keys,-PauseResp.rt,-CALearntrials.thisRepN,-CALearntrials.ran,-CALearntrials.thisTrialN,-CALearntrials.thisIndex, -CA_Proceed.keys,-CA_Proceed.rt,-headstartLearn.thisRepN,-headstartLearn.thisTrialN,-headstartLearn.thisIndex,-headstartLearn.thisN,-headstartLearn.ran,-ExpTrials.ran,-ExpTrials.thisIndex,-CA_trials.thisRepN,-CA_trials.thisN,-CA_trials.thisIndex,-CA_trials.thisTrialN,-CA_trials.ran,-AwareQ_loop.thisRepN,-AwareQ_loop.ran,-AwareQ_loop.thisIndex,-AwareQ_loop.thisTrialN,-todebrief.keys,-Finalend.keys)
# 
# 
# 
# #adjusting RT
# Exp7data$mainRT <- Exp7data$TargetResp.rt
# Exp7data$Block1RT <- Exp7data$CAResponse.rt
# 
# #splitting the RTs from main block
# Exp7data <- separate(Exp7data, col = mainRT, into = c("RTm_Trials", "RTm_secondary"), sep = ',')
# Exp7data$RTm_Trials <- Exp7data$RTm_Trials%>%
#   str_replace_all("\\[|\\]","")%>%
#   as.double(Exp7data$RTm_Trials)
# Exp7data$RTm_Trials <- 1000*(Exp7data$RTm_Trials)
# 
# #splitting RTs from the Ca learn block (1st block)
# Exp7data <- separate(Exp7data, col = Block1RT, into = c("RTb_Trials", "RTb_secondary"), sep = ',')
# Exp7data$RTb_Trials <- Exp7data$RTb_Trials%>%
#   str_replace_all("\\[|\\]","")%>%
#   as.double(Exp7data$RTb_Trials)
# Exp7data$RTb_Trials <- 1000*(Exp7data$RTb_Trials)
# 
# #removing RTs from guessing trials
# Exp7data$RTb_Trials <- ifelse(Exp7data$Block == "CG Learn", NA, Exp7data$RTb_Trials)
# 
# #creating a dummy variable to pick wherever the RTs are from main block and which are from first block
# Exp7data$RTdummy <- ifelse(is.na(Exp7data$TargetResp.rt) == FALSE,1,NA)
# Exp7data$RTdummy <- ifelse(is.na(Exp7data$CAResponse.rt)==FALSE,2,Exp7data$RTdummy)
# 
# #combining all important RTs
# Exp7data <- Exp7data %>%
#   mutate(RT_Trials = ifelse((RTdummy == 1), RTm_Trials,ifelse((RTdummy == 2),RTb_Trials,NA)))
# 
# 
# ###creating a separate df with the contingency awareness
# Exp7_CA <- Exp7data%>%
#   filter(Target == "?" | str_detect(AwareQ, "Press"))
# 
# 
# 
# 
# 
# Exp7data <- Exp7data%>%drop_na(RT_Trials)
# 
# #combining accuracy from first block and main block
# Exp7data$mainAcc <- Exp7data$TargetResp.corr
# Exp7data$Block1Acc <- Exp7data$CAResponse.corr
# Exp7data$BlockAcc <- ifelse(Exp7data$Block == "CG Learn", NA, Exp7data$Block1Acc)
# 
# Exp7data$ACCdummy <- ifelse(is.na(Exp7data$TargetResp.corr)==FALSE,1,NA)
# Exp7data$ACCdummy <- ifelse(is.na(Exp7data$CAResponse.corr)==FALSE,2,Exp7data$ACCdummy)
# 
# Exp7data <- Exp7data %>%
#   mutate(ACC_trials = ifelse((ACCdummy == 1),mainAcc,ifelse((ACCdummy == 2),Block1Acc,NA)))
# 
# 
# Exp7data$ErrorRate <- 1 - Exp7data$ACC_trials
# 
# #Error rate
# table(Exp7data$ACC_trials)
# round(table(Exp7data$ACC_trials)/nrow(Exp7data)*100, digits = 3)
# 
# #Exclude errors from RT
# 
# Exp7data$RT_Trials[Exp7data$ACC_trials==0] <- NA
# summary(Exp7data$RT_Trials)
# 
# #exclude outliers
# #creating function to remove the outliers and farouts
# computeTukeys <- function(x){
#   P25 <- quantile(x$RT_Trials, .25, na.rm = TRUE, type = 6) #type = 6 -> used in SPSS
#   P75 <- quantile(x$RT_Trials, .75, na.rm = TRUE, type = 6)
#   x$Outlier <- P75 + 1.5*(P75 - P25)
#   x$Farouts <- P75 + 3.0*(P75 - P25)
#   return(x)
# }
# 
# 
# #identifying the outliers and farouts at individual level
# Exp7data <- ddply(Exp7data, .(participant), computeTukeys)
# 
# #creating new column with RT trials after removing outliers/farouts
# Exp7data$RT_io <- Exp7data$RT_Trials
# 
# Exp7data$RT_io[Exp7data$RT_io > Exp7data$Outlier|Exp7data$RT_io < 200] <- NA
# summary(Exp7data$RT_io)
# 
# write.csv2(Exp7data, file="Data/data_prepared.csv", row.names = F) 

#+++++++++++++++++++++++++++++++++++++++++++++++++####
#Start here
#+++++++++++++++++++++++++++++++++++++++++++++++++
```{r}
#read prepared file (outliers and errors excluded)
raw.data<-read.csv2(file=here("Data","data_prepared.csv"))

#exclude participant with too many errors
raw.data<-subset(raw.data, subset=(raw.data$participant!="10"))

#reduce dataset
raw.data<-raw.data%>%
  select(Validity, Saliency, Condition, SalD, NSalD, CorrectAnswer, Target, RT_Trials, ACC_trials, participant, RT_io)

#limit dataset to sequences with trial n-1=learn and trial n=test####
raw.data<-raw.data%>%
  mutate(binding_sequence= ifelse(Condition=="test" & lag(Condition,1)=="learn" & lag(ACC_trials,1)==1 & lag(participant,1)==participant, 1,0))

raw.data<-raw.data%>%
  select(binding_sequence, Condition, everything())

table(raw.data$binding_sequence) #3832 relevant sequences

#code factors####
#DRel
raw.data<-raw.data%>%
  mutate(DRel =ifelse(binding_sequence==1 & Condition=="test" & Saliency=="Salient" & lag(SalD,1) == SalD,"DR",
                      ifelse(binding_sequence==1 & Condition=="test" & Saliency=="NonSalient" & lag(NSalD,1) == NSalD,"DR",
                             ifelse(binding_sequence==1 & Condition=="test" & Saliency=="Salient" & lag(SalD,1) != SalD,"DC",
                                    ifelse(binding_sequence==1 & Condition=="test" & Saliency=="NonSalient" & lag(NSalD,1) != NSalD,"DC",NA))))
         )

#RREl
raw.data<-raw.data%>%
  mutate(RRel=ifelse(binding_sequence==1 & CorrectAnswer==lag(CorrectAnswer,1), "RR",
                     ifelse(binding_sequence==1 & CorrectAnswer!=lag(CorrectAnswer,1), "RC",NA)))

#Probesalience
#equate to Saliency
raw.data<-raw.data%>%
  mutate(ProbeSaliency=ifelse(binding_sequence==1 & Condition=="test" &Saliency == "Salient", "salient",
                              ifelse(binding_sequence==1 & Condition=="test" &Saliency == "NonSalient", "nonsalient", NA)))


#get rid of all trials except test trials in relevant binding sequence
raw.data<-subset(raw.data, subset=(raw.data$binding_sequence==1))
raw.data$err<-1-raw.data$ACC_trials

#Aggregate ####
#Note: when validity is also included as additional factor, too many empty cells result and ezANOVA will not run. Hence, I ran the analyses first without the validity factor.
```

```{r}
agg.out <- aggregate(data = raw.data, RT_io ~ DRel + RRel + ProbeSaliency  + participant,mean)
agg.err <- aggregate(data = raw.data, err ~ DRel + RRel + ProbeSaliency  + participant, mean)
anova1 <- ezANOVA(data = agg.out,
                  dv = RT_io,
                  wid = .(participant),
                  within = .(DRel,RRel,ProbeSaliency),
                  detailed = TRUE)
anova_out(anova1)


write.csv2(agg.out, file="Data/agg_out.csv", row.names = F)
write.csv2(agg.err, file="Data/agg_err.csv", row.names = F)

#limit analyses only to valid test trials to avoid problem of too many missings
raw.data<-subset(raw.data, subset=(raw.data$Validity=="valid"))
OnlyVal_agg.out<- aggregate(data = raw.data, RT_io ~ DRel + RRel + ProbeSaliency  + participant, mean)
#too many empty cells to carry out ANOVA -> Model at the trial level to circumvent problem of missing data

write.csv2(OnlyVal_agg.out, file="Data/val_agg_out.csv", row.names = F)


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#analysis at the trial level####

table(raw.data$DRel)
table(raw.data$RRel)
table(raw.data$ProbeSaliency)
table(raw.data$Validity)

#create numeric variables for Multilevel analysis

raw.data$drel<-ifelse(raw.data$DRel=="DR", 1, -1)
table(raw.data$drel, raw.data$DRel)
summary(raw.data$drel)

raw.data$probesal<-ifelse(raw.data$ProbeSaliency=="salient", 1, -1)
table(raw.data$probesal, raw.data$ProbeSaliency)
summary(raw.data$probesal)

raw.data$val<-ifelse(raw.data$Validity=="valid", 1, -1)
table(raw.data$val, raw.data$Validity)
summary(raw.data$val) #but already all invalid trials are removed

raw.data$rrel<-ifelse(raw.data$RRel=="RR", 1, 2)
table(raw.data$rrel, raw.data$RRel)


#centering within person for RREl
#previous_rm
means.rrel <- aggregate(data = raw.data, rrel ~ participant, mean)
names(means.rrel)[2]<-"rrel_mean"

raw.data<-merge (raw.data, means.rrel, by="participant")

raw.data$rrel_cwp <- raw.data$rrel-raw.data$rrel_mean
summary(raw.data$rrel_cwp)

#random slopes model, Probe RT
#RT
randomSlopes_m1<-lmer(RT_io~1+probesal*drel*rrel_cwp + (1+probesal*drel*rrel_cwp|participant), 
                      data=raw.data, 
                      REML=F,
                      na.action = "na.omit")

summary(randomSlopes_m1)
#threeway interaction sign

#errors

randomSlopes_m1_err<-lmer(err~1+probesal*drel*rrel_cwp + (1+probesal*drel*rrel_cwp|participant), 
                      data=raw.data, 
                      REML=F,
                      na.action = "na.omit")

summary(randomSlopes_m1_err)
#threeway interaction sign
#so far: MLM analyses correspond to analyses at the aggregated level!

#+++++++++++++++++++++++
#incorporate test trial validity to the model

#RT
randomSlopes_m2<-lmer(RT_io~1+probesal*drel*rrel_cwp*val + (1+probesal*drel*rrel_cwp*val|participant), 
                      data=raw.data, 
                      REML=F,
                      na.action = "na.omit")

summary(randomSlopes_m2)
#threeway interaction sign

#errors

randomSlopes_m2_err<-lmer(err~1+probesal*drel*rrel_cwp*val + (1+probesal*drel*rrel_cwp*val|participant), 
                          data=raw.data, 
                          REML=F,
                          na.action = "na.omit")

summary(randomSlopes_m2_err)


#test model fit
randomIntercept_m0<-lmer(RT_io~1 + (1|participant), 
                         data=raw.data, 
                         REML=F,
                         na.action = "na.omit")
summary(randomIntercept_m0)

randomIntercept_m0_err<-lmer(err~1 + (1|participant), 
                             data=raw.data, 
                             REML=F,
                             na.action = "na.omit")
summary(randomIntercept_m0_err)

#Model comparison
#Model 1 vs Model0

anova(randomIntercept_m0, randomSlopes_m1) #sign
anova(randomIntercept_m0_err, randomSlopes_m1_err) #sign

#Model 2 vs model 1
anova(randomSlopes_m1, randomSlopes_m2) #no sign model improvement
anova(randomSlopes_m1_err, randomSlopes_m2_err) #no sign model improvement

#check for confunds in the factorial design####
table(raw.data$DRel, raw.data$RRel )
round(table(raw.data$DRel, raw.data$RRel )/nrow(raw.data)*100, digits = 2)

table(raw.data$DRel, raw.data$RRel, raw.data$ProbeSaliency )
round(table(raw.data$DRel, raw.data$RRel, raw.data$ProbeSaliency )/nrow(raw.data)*100, digits = 1)

round(table(raw.data$DRel, raw.data$RRel, raw.data$ProbeSaliency, raw.data$Validity )/nrow(raw.data)*100, digits = 1)

table(raw.data$DRel, raw.data$RRel, raw.data$Validity, raw.data$ProbeSaliency) 

table(raw.data$DRel, raw.data$RRel, raw.data$Validity) 
round(table(raw.data$DRel, raw.data$RRel, raw.data$Validity) /nrow(raw.data)*100, digits = 1)


#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#Analyze Binding effect at the aggragted level, Probe performance as a function of ProbeSaliency, DRel, RREl####
#ANOVA

data<-read.csv2(file="Data/agg_out.csv")
data<-read.csv2(file="Data/agg_err.csv")

data<-OnlyVal_agg.out

data$DRel<-as.factor(data$DRel)
data$RRel<-as.factor(data$RRel)
data$participant<-as.factor(data$participant)
data$ProbeSaliency<-as.factor(data$ProbeSaliency)
#when validity is included: 16 cells, all participants have missing data


table(data$participant)


#RT####
ezout<-ezANOVA( data=data,
                dv=RT_io,
                wid = participant,
                within= .(DRel, RRel, ProbeSaliency),
                detailed=T)
anova_out(ezout)
#3way interaction is significant

#plot
#Grafik 
plot_RT<-ezPlot(data=data,
       dv=RT_io, 
       wid=participant, 
       within = .(DRel, RRel, ProbeSaliency), 
       x = RRel, 
       levels = list(RRel = list(new_order = c('RR', 'RC'))),
       split = DRel, 
       col = ProbeSaliency, 
       y_lab ='ProbeRT (ms)',
       do_bars =FALSE)+
  theme_bw()+ylim(500,600)

plotDRRR <- ggplot(data = data,aes(x = RRel, y = RT_io, color = DRel))+
  geom_line(aes(group = DRel, linetype = DRel),size = 1,stat = "summary", fun = "mean",)+
  geom_point(stat = "summary", fun = "mean", aes(shape = DRel))+
  facet_grid(.~ProbeSaliency)+labs(color  = "Distractor Relation", linetype = "Distractor Relation", shape = "Distractor Relation")+
  scale_color_manual(values = c("deepskyblue4","cadetblue3"))+
  coord_cartesian(ylim = c(500,600))+
  theme_classic()+ylab("ProbeRT (in ms)")+xlab("Response Relation")+ggtitle("Interaction of Response Relation and \n Distractor Relation across Saliency")
plotDRRR
print(plot_RT)
ggsave("Figures/ProbeSaliency x DRel x RRel_RT.png")
ggsave(filename = here("Figures","ProbeSalDRelRRel_RT.png"),plotDRRR)


#graph shows standard binding for salient D, reversed pattern for nonsalient D
#follow up

SalientProbe<-subset(data, subset=(ProbeSaliency=="salient"))
ezout<-ezANOVA( data=SalientProbe,
                dv=RT_io,
                wid = participant,
                within= .(DRel, RRel),
                detailed=T)
anova_out(ezout)
#DRelxRREl interaction sign

ezStats(data=SalientProbe,
        dv=RT_io,
        wid = participant,
        within = .(RRel),
        within_full = .(DRel, RRel),
        diff=.(DRel),
        reverse_diff = T)

#t.tests:
t<- t.test(RT_io ~ DRel, data =SalientProbe, subset =(RRel=="RR"), paired=TRUE, alternative="greater" )
t_out(t, d.corr=FALSE)
#facilitation sign

t<- t.test(RT_io ~ DRel, data =SalientProbe, subset =(RRel=="RC"), paired=TRUE, alternative="less" )
t_out(t, d.corr=FALSE)
#cost ns

NonSalientProbe<-subset(data, subset=(ProbeSaliency=="nonsalient"))
ezout<-ezANOVA( data=NonSalientProbe,
                dv=RT_io,
                wid = participant,
                within= .(DRel, RRel),
                detailed=T)
anova_out(ezout)
#DRelxRrel ns

#Errors####
ezout<-ezANOVA( data=data,
                dv=err,
                wid = participant,
                within= .(DRel, RRel, ProbeSaliency),
                detailed=T)
anova_out(ezout)
#threeway iA sign

plotDRRR_err <- ggplot(data = data,aes(x = RRel, y = err, color = DRel))+
  geom_line(aes(group = DRel, linetype = DRel),size = 1,stat = "summary", fun = "mean",)+
  geom_point(stat = "summary", fun = "mean", aes(shape = DRel))+
  facet_grid(.~ProbeSaliency)+labs(color  = "Distractor Relation", linetype = "Distractor Relation", shape = "Distractor Relation")+
  scale_color_manual(values = c("deepskyblue4","cadetblue3"))+
  coord_cartesian(ylim = c(0,0.15))+
  theme_classic()+ylab("ProbeErrorRate")+xlab("Response Relation")+ggtitle("Interaction of Response Relation and \n Distractor Relation across Saliency")
plotDRRR_err

#ggsave("Figures/ProbeSaliency x DRel x RRel_RT.png")
ggsave(filename = here("Figures","ProbeSalDRelRRel_err.png"),plotDRRR_err)

#plot
plot_err<-ezPlot(data=data,
       dv=err, 
       wid=participant, 
       within = .(DRel, RRel, ProbeSaliency), 
       x = RRel,
       levels = list(RRel = list(new_order = c('RR', 'RC'))),
       split = DRel, 
       y_lab ='Probe error rate',
       col = ProbeSaliency, 
       do_bars =FALSE)+
  theme_bw() 
print(plot_err)
ggsave("Figures/ProbeSaliency x DRel x RRel_errors.png")

#graph shows standard binding for salient D, reversed pattern for nonsalient D
#follow up

SalientProbe<-subset(data, subset=(ProbeSaliency=="salient"))
ezout<-ezANOVA( data=SalientProbe,
                dv=err,
                wid = participant,
                within= .(DRel, RRel),
                detailed=T)
anova_out(ezout)
#DRelxRREl interaction sign

ezStats(data=SalientProbe,
        dv=err,
        wid = participant,
        within = .(RRel),
        within_full = .(DRel, RRel),
        diff=.(DRel),
        reverse_diff = T)

#t.tests:
t<- t.test(err ~ DRel, data =SalientProbe, subset =(RRel=="RR"), paired=TRUE, alternative="greater" )
t_out(t, d.corr=FALSE)
#facilitation marginal sign in one.taield test

t<- t.test(err ~ DRel, data =SalientProbe, subset =(RRel=="RC"), paired=TRUE, alternative="less" )
t_out(t, d.corr=FALSE)
#cost sign

NonSalientProbe<-subset(data, subset=(ProbeSaliency=="nonsalient"))
ezout<-ezANOVA( data=NonSalientProbe,
                dv=err,
                wid = participant,
                within= .(DRel, RRel),
                detailed=T)
anova_out(ezout)
#DRelxRrel ns
```